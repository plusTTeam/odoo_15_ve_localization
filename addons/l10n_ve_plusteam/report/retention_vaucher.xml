<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record id="action_comprobante_retention" model="ir.actions.report">
        <field name="name">Comprobante IVA</field>
        <field name="model">retention</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">l10n_ve_plusteam.report_comprobante_retention</field>
        <field name="report_file">report_comprobante_retention</field>
        <field name="print_report_name">'Comprobante - %s' % (object.retention_code)</field>
        <field name="paperformat_id" ref="l10n_ve_plusteam.paperformat_retention_format"/>
        <field name="binding_model_id" ref="l10n_ve_plusteam.model_retention"/>
        <field name="binding_type">report</field>
    </record>

    <template id="report_comprobante_retention">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="retention">
                <t t-call="web.basic_layout">

                    <div class="page" style="line-height:0.8 ">
                        <p>
                            <small>(Ley IVA_Artículo 11: La Administración Tributaria podrá designar como responsables
                                del pago
                                del impuesto, en calidad de agentes de retención, a quienes por sus funciones públicas o
                                por razón
                                de sus actividades privadas intervengan en operaciones gravadas con el impuesto
                                establecido en esta Ley.)
                            </small>
                        </p>
                        <h5 align="center">
                            <u>COMPROBANTE DE RETENCIÓN DEL IMPUESTO AL VALOR AGREGADO</u>
                        </h5>
                        <div class="container-fluid" >
                            <div class="row">
                                <div class="col-6 text-left">
                                    Nro Comprobante <strong><span t-field="retention.retention_code"/></strong>
                                </div>
                                <div class="col-5 align-self-end justify-content-end text-right">
                                    Fecha Emisión: <span t-field="retention.retention_date"/>
                                </div>
                            </div>
                        </div>
                        <h6>
                            <u>DATOS DEL AGENTE DE RETENCIÓN</u>
                        </h6>
                        <div class="container-fluid" >
                            <div class="row">
                                <div class="col-6 text-left">
                                    Nombre/Razon Social: <span t-field="retention.company_id.name"/>
                                </div>
                                <div class="col-5 align-self-end justify-content-end text-right">
                                    <p>Periodo Fiscal: Mes <span t-field="retention.month_fiscal_period"/>  Año
                                    <span t-field="retention.year_fiscal_period"/></p>
                                </div>
                            </div>
                        </div>
                        <div class="container-fluid" >
                            <p> </p>
                        </div>
                        <div class="container-fluid" >
                            <p>Número RIF: <span t-field="retention.company_id.vat"/></p>
                            <p>Dirección Fiscal:
                                <span t-field="retention.company_id.street"/>
                                <span t-field="retention.company_id.city"/>
                                <span t-field="retention.company_id.state_id.country_id"/>
                            </p>
                        </div>
                        <h6>
                            <u>DATOS DEL PROVEEDOR</u>
                        </h6>
                        <div class="container-fluid" >
                            <p>Nombre/Razon Social:
                                <span t-field="retention.partner_id.name"/>
                            </p>
                            <p>Número RIF:
                                <span t-field="retention.partner_id.vat"/>
                            </p>
                        </div>
                        <h6>
                            <u>DATOS DE LA COMPRA</u>
                        </h6>
                        <div class="container-fluid" >
                         <div class="row">
                                <div class="col-6 text-left">
                                    <t t-if="retention.invoice_id.debit_origin_id ">
                                        <p>Número de la Factura:
                                            <span/>
                                        </p>
                                    </t>
                                    <t t-if="retention.move_type in ('in_invoice', 'out_invoice') and not retention.invoice_id.debit_origin_id ">
                                        <p>Número de la Factura:
                                            <span t-field="retention.invoice_id.document_number"/>
                                        </p>
                                    </t>
                                    <t t-if="retention.move_type in ('in_refund', 'out_refund')">
                                        <p>Número de la Nota de Credito:
                                            <span t-field="retention.invoice_id.document_number"/>
                                        </p>
                                    </t>
                                    <t t-else=" ">
                                        <p>Número de la Nota de Credito:
                                            <span/>
                                        </p>
                                    </t>
                                    <t t-if="retention.invoice_id.debit_origin_id ">
                                        <p>Número de la Nota de Debito:
                                            <span t-field="retention.invoice_id.document_number"/>
                                        </p>
                                    </t>
                                    <t t-else="">
                                        <p>Número de la Nota de Debito:
                                            <span/>
                                        </p>
                                    </t>
                                    <p>Número de Control:
                                        <span t-field="retention.control_number"/>
                                    </p>
                                    <t t-if="retention.invoice_id.debit_origin_id ">
                                        <p>Número de la Factura Afectada:
                                            <span t-field="retention.invoice_id.debit_origin_id.document_number"/>
                                        </p>
                                    </t>
                                    <t t-if="retention.move_type in ('in_refund', 'out_refund') ">
                                        <p>Número de la Factura Afectada:
                                            <span t-field="retention.invoice_id.ref"/>
                                        </p>
                                    </t>
                                    <p>Fecha de Emisión:
                                        <span t-field="retention.invoice_id.date"/>
                                        <br/>
                                    </p>
                                </div>
                                <div class="col-6  text-center">
                                    <p>_________________________</p>
                                    <p>  Fecha de Entrega </p>
                                    <p><span t-field="retention.retention_date"/></p>
                                </div>
                         </div>
                        </div>
                        <h6>
                            <u>DETALLES DEL CALCULO DE LA RETENCIÓN</u>
                        </h6>
                        <p>Porcentaje de la Retención:
                            <span t-field="retention.vat_withholding_percentage"/>
                            %
                        </p>
                        <div class="table-responsive-sm">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th scope="col"></th>
                                    <th scope="col" class="text-center">Total Compra con IVA</th>
                                    <th scope="col" class="text-center">Exentas y/o sin derecho a Credito</th>
                                    <th scope="col" class="text-center">Base  Imponible</th>
                                    <th scope="col" class="text-center">% Alicuota</th>
                                    <th scope="col" class="text-center">Impuesto Iva</th>
                                    <th scope="col" class="text-center">Iva Retenido</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-set="contador" t-value="1"/>
                                <t t-foreach="retention.invoice_id.amount_by_group" t-as="amount_by_group">
                                    <tr>
                                        <t t-if="amount_by_group[5]>1 and amount_by_group[1]>0">
                                            <td>
                                                <span/>
                                            </td>
                                            <td class="text-right " t-if="contador==1">
                                                <span t-esc="'{:,.2f}'.format(retention.amount_total)"/>
                                            </td>
                                            <td class="text-right " t-if="contador==1">
                                                <span t-esc="'{:,.2f}'.format(retention.amount_base_untaxed)"/>
                                            </td>
                                            <td t-if="contador==0">
                                                <span/>
                                            </td>
                                            <td t-if="contador==0">
                                                <p>
                                                    <span t-options='{"widget": "monetary", "display_currency": retention.company_currency_id}'/>
                                                </p>
                                            </td>
                                            <t t-set="contador" t-value="0"/>
                                            <td name="td_amount_by_group" class="text-right o_price_total">
                                                <span t-esc="'{:,.2f}'.format(amount_by_group[2])"/>
                                                <span>&amp;nbsp;</span>
                                            </td>
                                            <t t-set="amount_porcentage"
                                               t-value="amount_by_group[1]*100/amount_by_group[2]"/>
                                            <td name="td_amount_by_group_label" class="text-right">
                                                <span t-esc="amount_porcentage"/>
                                            </td>
                                            <td name="td_amount_by_group" class="text-right o_price_total">
                                                <span t-esc="'{:,.2f}'.format(amount_by_group[1])"/>
                                            </td>
                                            <t t-set="amount_retention_subtotal"
                                               t-value="retention.vat_withholding_percentage*amount_by_group[1]/100"/>
                                            <td name="td_amount_by_group" class="text-right o_price_total">
                                                <span
                                                        t-esc="amount_retention_subtotal"/>
                                            </td>
                                        </t>

                                    </tr>

                                </t>
                                <tr>
                                    <td>Totales</td>
                                    <td class="text-center">
                                        <span t-esc="'{:,.2f}'.format(retention.amount_total)"/>
                                    </td>
                                    <td class="text-center">
                                        <span t-esc="'{:,.2f}'.format(retention.amount_base_untaxed)"/>
                                    </td>
                                    <td class="text-center">
                                        <span t-esc="'{:,.2f}'.format(retention.amount_base_taxed)"/>
                                    </td>
                                    <t t-if="contador==1">
                                        <td class="text-center">
                                            <span t-esc="retention.invoice_id.line_ids.tax_ids.amount"/>
                                        </td>
                                    </t>
                                    <t t-else=" ">
                                        <td>
                                            <span/>
                                        </td>
                                    </t>
                                    <td class="text-center">
                                        <span t-esc="'{:,.2f}'.format(retention.amount_tax)"/>
                                    </td>
                                    <td class="text-center">
                                        <span t-esc="'{:,.2f}'.format(retention.amount_retention)"/>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                </t>
            </t>
        </t>
    </template>
</odoo>
